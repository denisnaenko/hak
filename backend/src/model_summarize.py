import requests
import json
import os

# Конфигурация для OpenRouter
OPENROUTER_API_KEY = os.getenv("OPENROUTER_API_KEY") or "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"
OPENROUTER_MODEL = "qwen/qwen3-vl-30b-a3b-thinking"


def make_openrouter_request(model, text):
    """Выполняет запрос к OpenRouter API для указанной модели и возвращает результаты."""
    try:
        print(f"=== Запрос для модели {model} (OpenRouter) ===")
        response = requests.post(
            url="https://openrouter.ai/api/v1/chat/completions",
            headers={
                "Authorization": f"Bearer {OPENROUTER_API_KEY}",
                "Content-Type": "application/json",
            },
            data=json.dumps({
                "model": model,
                "messages": [
                    {
                        "role": "user",
                        "content": text
                    }
                ],
                "extra_body": {"reasoning": {"enabled": True}}
            }),
            timeout=30
        )
        
        status_code = response.status_code
        if status_code != 200:
            print(f"Ошибка для {model}: {status_code}")
            print(response.text if hasattr(response, 'text') else "Нет текста ошибки")
            return {
                "model": model,
                "response": f"Ошибка: {status_code}",
                "reasoning_present": False,
                "status_code": status_code
            }
        
        data = response.json()
        assistant_message = data['choices'][0]['message']
        content = assistant_message.get('content', 'Нет содержимого')
        reasoning_present = 'reasoning_details' in assistant_message
        
        print(f"Ответ: {content}")
        print(f"Reasoning details присутствуют: {reasoning_present}")
        
        return {
            "model": model,
            "response": content,
            "reasoning_present": reasoning_present,
            "status_code": status_code
        }
            
    except requests.exceptions.Timeout:
        print(f"Таймаут для {model}")
        return {
            "model": model,
            "response": "Таймаут",
            "reasoning_present": False,
            "status_code": -1
        }
    except requests.exceptions.RequestException as e:
        print(f"Ошибка сети для {model}: {e}")
        return {
            "model": model,
            "response": f"Ошибка сети: {e}",
            "reasoning_present": False,
            "status_code": -2
        }
    except KeyError as e:
        print(f"Ошибка в структуре ответа для {model}: {e}")
        return {
            "model": model,
            "response": f"Ошибка парсинга: {e}",
            "reasoning_present": False,
            "status_code": 0
        }
    except Exception as e:
        print(f"Неожиданная ошибка для {model}: {e}")
        return {
            "model": model,
            "response": f"Неожиданная ошибка: {e}",
            "reasoning_present": False,
            "status_code": -3
        }

def save_summarized_result(text):    
    # Обработка OpenRouter моделей
    summarized_result = make_openrouter_request(OPENROUTER_MODEL, text)
        
    return summarized_result

if __name__ == '__main__':
    text = """
    === Результат анализа 1 ===
{'model': 'x-ai/grok-4.1-fast:free', # Сравнительный анализ тарифов дебетовых карт\n\n**Продукт: Тарифы дебетовых карт (основные условия обслуживания).  \n**Банки-конкуренты: Сбер, ВТБ, Альфа-Банк, Тинькофф.  \n**Критерии сравнения: Бесплатное обслуживание, Бесплатные СМС-уведомления, Бесплатное снятие наличных в других банках, Бесплатные переводы по реквизитам, Процент на остаток, Кэшбэк от партнеров.  \n\nДанные основаны на актуальных тарифах (значения: `true` — бесплатно/доступно без ограничений; `false` — отсутствует; числа — лимиты в тыс. руб. для бесплатных операций или % ставки).\n\n## Таблица сравнения\n\n| Критерий                          | Сбер          | ВТБ     | Альфа-Банк | Тинькофф |\n|-----------------------------------|---------------|---------|------------|----------|\n| **Бесплатное обслуживание      | true         | 1000 руб. (мин. остаток) | 500 руб. (мин. остаток) | true    |\n| Бесплатные СМС-уведомления   | true         | true   | 50 руб./мес. | true    |\n| Бесплатное снятие наличных в других банках | до 2 тыс. руб. | до 1 тыс. руб. | true      | до 5 тыс. руб. |\n| Бесплатные переводы по реквизитам | true       | true   | true      | true    |\n| Процент на остаток           | 11.7%        | 20.0%  | false     | 12%     |\n| Кэшбэк от партнеров          | true         | true   | true      | true    |\n\n**Лидер по сумме критериев: Тинькофф (наиболее сбалансированное предложение по бесплатным лимитам и ставкам).\n\n## Анализ и выводы\n\n### Конкурентные преимущества Сбера\nСбер демонстрирует сильные позиции по нескольким ключевым критериям, где условия полностью бесплатны или конкурентны:\n- **Бесплатные СМС-уведомления: Полностью бесплатно (true), в отличие от Альфа-Банка (50 руб./мес.). Это преимущество для клиентов, ценящих оперативный контроль расходов.\n- Бесплатные переводы по реквизитам: Доступны без ограничений (true), наравне с конкурентами, что делает продукт удобным для расчетов с физлицами и юрлицами.\n- Процент на остаток: 11.7% — выше, чем у Тинькофф (12%), и значительно лучше Альфа-Банка (отсутствует). Это выгодно для сберегательных сценариев.\n- Кэшбэк от партнеров: Доступен (true), аналогично конкурентам, с широкой экосистемой Сбера (Спасибо), что усиливает лояльность.\n\nЭти преимущества делают тариф Сбера привлекательным для повседневного использования без скрытых платежей.\n\n### Области отставания от конкурентов\nНесмотря на сильные стороны, по ряду критериев Сбер уступает:\n- Бесплатное обслуживание: Требует выполнения условий (true подразумевает базовый тариф без мин. остатка), в то время как ВТБ и Альфа предлагают с мин. остатком 1000/500 руб., а Тинькофф — полностью бесплатно. Это может отпугивать клиентов с низким балансом.\n- Бесплатное снятие наличных в других банках: Лимит всего 2 тыс. руб., хуже ВТБ (1 тыс. руб., но с другими бонусами), Альфа (безлимитно) и Тинькофф (5 тыс. руб.). Конкуренты лидируют для наличных операций.\n- Процент на остаток: 11.7% ниже ВТБ (20%), что критично для крупных остатков (>100 тыс. руб.).\n\nОбщий лидер — Тинькофф, благодаря максимальным бесплатным лимитам и балансу.\n\n### Рекомендация по целевым клиентам\n- Наиболее выгоден для: Молодых клиентов (25–40 лет) с средним доходом (50–150 тыс. руб./мес.), ориентированных на цифровые переводы, уведомления и кэшбэк в экосистеме (покупки в Сбер-партнерах). Идеален для семей с детьми (SMS для контроля расходов) или фрилансеров (переводы по реквизитам). Не подходит для любителей наличных (низкий лимит снятия) или high-income с крупными остатками (ВТБ лучше по %).\n- Избегать: Клиентам старше 50 лет, предпочитающим наличные (Альфа/Тинькофф выгоднее), или с минимальными остатками (Тинькофф без условий).\n\n### Рекомендации по развитию продукта\n- Улучшить слабые критерии: Увеличить лимит бесплатного снятия наличных до 5–10 тыс. руб. (как у Тинькофф) для конкуренции в регионах. Ввести полное бесплатное обслуживание без мин. остатка или снизить порог до 0 руб. для активных пользователей (переводы >10 тыс. руб./мес.).\n- Усилить преимущества: Повысить % на остаток до 15% для остатков до 1 млн руб., интегрировать персонализированный кэшбэк (до 30% у партнеров). Добавить опцию "Супер-SMS" с AI-аналитикой расходов бесплатно.\n- Целевые инициативы: Тестировать A/B на аудитории 25–40 лет: пакет "Цифровой" с повышенными лимитами за подписку (99 руб./мес.). Мониторить ВТБ по % — если вырастет конкуренция, ввести tiered-ставки (до 18% при тратах >50 тыс. руб.).\n- Метрики успеха: Увеличение NPS на 10% за счет снижения оттока по наличным операциям; цель — 2-е место в таблице через 6 мес.\n\nЭтот анализ объективен и основан на предоставленных данных, помогая приоритизировать улучшения для повышения конкурентоспособности.', 'reasoning_present': True, 'status_code': 200}
==================================================
=== Результат анализа 2 ===
{'model': 'deepseek/deepseek-r1-0528-qwen3-8b', 'response': 'Отлично, вот развернутый анализ и выводы на основе предоставленных данных:\n\n**Анализ и выводы:\n\n**1. Анализ конкурентных преимуществ Сбер Банка**\n\nНа основе сравнения по заданным критериям можно выделить следующие сильные стороны продукта Сбер Банка:\n\n*   **Бесплатные СМС-уведомления: Продукт Сбера существенно выделяется на рынке, предлагая бесплатные уведомления. Другие банки (ВТБ, Тинькофф) также предлагают этот функционал бесплатно, а вот Альфа-Банк устанавливает ограничение по количеству бесплатных сообщений, что делает его предложение менее привлекательным для клиентов, активно использующих уведомления.\n*   Бесплатные переводы по реквизитам: Еще один востребованный клиентом функционал, не имеющий ограничений в Сбере. Равноценен предложению ВТБ, Тинькофф и Альфа-Банка.\n*   Процент на остаток (11.7% годовых): Несмотря на то, что некоторые банки (ВТБ, Тинькофф) предлагают более высокий процент, отсутствие платы за ведение счета и плавающая ставка делают предложение Сбера очень привлекательным, особенно для клиентов, накапливающих определенную сумму и предпочитающих избежать тарифов.\n*   Кэшбэк от партнеров: Предложение Сбера заслуживает внимания в своей категории. Вместе с бесплатными СМС-уведомлениями и переводами, этот накопительный бонус может формировать сильную лояльную клиентскую базу.\n\nВ целом, Сбер Банк олицетворяет собой модель с минимальными (или отсутствующими) прямыми ограничениями на базовые банковские операции (пока не отдельный продукт *для* студентов с уголовным(!) сроем смены валюты, например) и большим (но пока не максимальным) кэшбэком в рамках экосистемы.\n\n**2. Анализ позиций конкурентов и недостатков Сбер Банка**\n\nКонкуренты предлагают следующие альтернативы или отличия:\n\n*   Процент на остаток: ВТБ (20.0%) предлагает значительно более привлекательный процент для вкладчиков "вклад" или капитала. Тинькофф (12%) также предлагает конкурентный процент. Недостаток Сбера здесь – не максимальная ставка.\n*   Снятие наличных в других банках: Это один из явных рычагов для Сбера и Альфа-Банка (пока не ясно, что за почасовая система – но факт наличия услуги и минимальной платы!). Сбер предлагает услугу со ставкой 2%, что ниже возлагаемого ВТБ и Альфа-Банком на другие счета/учетные записи (у Альфа-Банка упоминается "бесплатное" после некоторой лимитации, который таймется до пополнения). Стоит отметить привлекательную и массово доступную (хотя ОЧЕНЬ не дематертвальное предложение) услугу Тинькофф *"Free Кэш"* для студентов/молодых людей с льготным обслуживанием, особенно уникальное предложение безлимитного снятия *валюты* (так, в долларах или евро) внутри СНГ – хоть она и требует наличия ряда подписок в ПЛП.\n*   Услуга "Бесплатное обслуживание":**\n    *   Альфа-Банк явно "учереждает" это как привилегию торты/credits. Подробнее в сравнение по основным счетам (для физлиц, наверное).\n    *   ВТБ и Тинькофф просто указывают "да". Хорошая практика.\n    *   Сбер Банк не фиксирует значение "Бесплатное обслуживание" как абсолютное, но предлагает неограниченный лицевой счет со ставкой 11.7%. *Рекомендация: Если функционал лицевого счета строго соответствует (не отличается высоким максимальным лимитом), то Сбер Банк мог бы заполнить данное поле "Бесплатное обслуживание" – "да", либо четко разграничить различные схемы предоставления неограниченных счетов.*\n\n**3. Сбалансированная рекомендация по целевым клиентам**\n\nПродукт Сбер Банка является универсальным, но будет наиболее выгоден и желанным для следующих категорий клиентов:\n\n*   **Высокомотивированные клиенты с фиксированным доходом: В первую очередь – тем, кто не боится гиперконкурентных цен на традиционных интернет-банках (Тинькофф, Альфа-Лизинг за Льготный Картинг со ставкой 0% на month), а ценит именно *отсутствие* прямых финансовых штрафов и хлопот кредитования на общие счета. Соответственно – miles and miles разбросаны по шкапам продуктового анализа. Часто это средний класс, занятые люди, благополучные пенсионеры с целеустремленнностью на корочку от вычета телефон/mobile.\n*   Средний/начальный уровень дохода: Предложение бесплатных/низкоплатных операций и приемлемой ставки на вклад делает его конкурентноспособным, даже если гиперконкуренты сносят и свою "Лозунг Paulette". Если рассматривать альтернативы – здесь явное пересечение с теми же студентами, но уже со средним/высоким студенческим доходом (да как же... topping выдачи зарплат).\n*   Клиенты, активно использующие цифровые сервисы Сбера: Экосистемное преимущество ПЛП-банкинга – возможность получать максимальную отдачу не только от продуктового обслуживания в рамках Сбера, но и от программ партнеров, эффективное зачисление при определенных действиях/бонусах. Здесь Сбер Банк гармонично вписывается как часть комплексного экосистемного обслуживания.\n\nПользователи же с самыми высокими доходами и финансовыми целями могут искать предложения ВТБ или персонального обслуживания Альфа-Банка с их высокими ставками и другими услугами. Тинькофф же привлекает своей гиперросизмостью цен/ставок и узким нишевым подходом, но масштабируемостью.\n\n**4. Рекомендации по развитию продукта**\n\nУчитывая анализ, предлагается сосредоточить усилия на следующем:\n\n*   Задача 1: Актуализация и улучшение параметра "Процент на остаток":**\n    *   Постоянно оценивать рыночный лидер за лидером по всевозможным штучкам. Считать не предлагается, но отслеживать уровни ставок своих конкурентов, особенно ВТБ и Тинькофф.\n    *   Выпуск более конкурентных "тарифных сегментов" по ставкам (возможно, *особые* тарифные планы для клиентов digit-продуктов Сбер? Типа "Golden процентчик").\n*   **Задача 2: Устранение (или рационализация) операционных расходов по "Бесплатное снятие наличных" услуги:**\n    *   Попытаться перечислить все! Возможно, стоит выделить максимально привлекательный "бесплатный" тариф *не* на основной счет, а именно на счете "Экспресс-кошелек" (который бесплатен по наличным, а не основной).\n    *   Предложить более выгодные условия "бесплатного" снятия наличных *в рамках* Другого-online-банка вместо Сбер Банка (если лямбда такова). Поклонники распродажи приходят сюда не иначе как облажались.\n*   **Задача 3: Глубина восприятия кэшбэка:**\n    *   Убедиться, что ограничения на Альфа-Инвестиции и ПЛПбанкинг не剥夺и privileges. Проверить (и внедрить) максимально широкий диапазон скоупинговых бонусов по возможностям – особенно для дилеров платежных систем (как сейчас).\n*   **Задача 4: Усиление присутствия на сегменте студентов с "универсалистами":**\n    *   Взять за основу создание "общистемного академического картинга" со специфическими тарифами/соцпакетами по ставке 0 или очень маленькая на months-base для определенных продуктах кредитования или масштабных использования систем. Либо взять идею Тинькофф *Free Кэш*, но с рядом корректировок на доступность/подписка на muzdrav/edrav/kinder surprise.\n    *   Дорабатывание уникального value предложения через сложную вовлеченность или раскладной процент с увеличением на рост через плагины экосистемы (например, доставка с mealiever, значит – процент на наличные выше).\n*   **Задача 5: "Бесплатное обслуживание" цифровой реинкарнации:**\n    *   Создать тарифный план счета (даже с оговоркой по лимиту платежности или локации), копируя канон с ABBVIE и ТК, но не сверх нормы. Six-pack для Сбер Банка создать на томировку отделениям банковского бизнеса.\n\n**Заключение:**\n\nСбер Банк занимает выгодное положение на рынке "Бесплатных интернет-услуг для среднего класса", предложив конкурентноспособный набор основных функций без высоких тариф (кроме возможных панибратственных вычетов по ставкям "висячий зад". Against невысоких процентных ставок на вкладах он должен бороться не только via рекламы, а и подчеркивая соотношение цена/качество услуг. Развитие экосистемного подхода и адаптация под узкие ниши по мере необходимости укрепят позиции.', 'reasoning_present': True, 'status_code': 200}
==================================================
=== Результат анализа 3 ===
{'model': 'giga-chat', 'response':  '## Анализ и выводы\n\n### Преимущества Сбера над конкурентами\n\nПродукт Сбера демонстрирует ряд сильных сторон относительно предложений конкурентов:\n\n#### Бесплатные услуги:\n- **СМС-уведомления – услуга предоставляется бесплатно во всех рассматриваемых банках.\n- Переводы по реквизитам – абсолютно бесплатны для клиентов Сбера и его конкурентов.\n- Процент на остаток счета – Сбербанк предлагает процентную ставку в размере 11,7%, уступая лишь ВТБ, однако ставка последнего составляет 20% годовых, что делает условия Сбербанка более привлекательными для массового клиента.\n- Кэшбэк от партнеров – бесплатная опция присутствует во всех рассмотренных банках.\n\nТаким образом, Сбербанк выделяется среди конкурентов бесплатностью услуг СМС-уведомлений, переводов по реквизитам и наличием кэшбэка от партнеров.\n\n---\n\n### Недостатки и зоны роста\n\nНесмотря на очевидные сильные стороны, есть области, где предложения конкурентов выглядят предпочтительнее:\n\n- Обслуживание и снятие наличных в других банках:  \n   Услуга доступна лишь в ограниченном объеме у Сбера (2 операции в месяц), тогда как Альфа-Банк и Тинькофф предоставляют неограниченное количество бесплатных операций снятия наличных в любых банках. Это создает дополнительное удобство для клиентов, часто пользующихся услугами различных финансовых учреждений.\n   \n- Стоимость обслуживания:  \n   Хотя Сбербанк является лидером по количеству бесплатных услуг, бесплатное обслуживание доступно далеко не повсеместно. ВТБ, Альфа-Банк и Тинькофф предлагают платное обслуживание, однако в ряде случаев оно компенсируется иными преимуществами (например, высоким процентом на остаток).\n\n---\n\n### Целевые сегменты клиентов\n\nНа основании проведенного анализа продукт Сбера рекомендуется рассматривать следующим категориям клиентов:\n\n- Молодежь и студенты: отсутствие комиссии за обслуживание и бесплатные уведомления сделают тариф особенно привлекательным.\n- Средний класс: клиенты с регулярными переводами по реквизитам оценят бесплатную услугу.\n- Любители кэшбэков: наличие бонусной программы станет дополнительным стимулом.\n\n---\n\n### Советы по улучшению продукта\n\nДля повышения конкурентоспособности продукта Сберу рекомендуется:\n\n- Расширение бесплатной опции снятия наличных в других банках до уровня конкурентов (без ограничений).  \n  Пример: возможность снимать деньги без комиссий ежемесячно в любом количестве отделений любого российского банка.\n  \n- Улучшение условий обслуживания премиум-клиентов.  \n  Например, предоставление персональных менеджеров, эксклюзивных бонусов и льгот.\n\n- Повышение процента на остаток, чтобы оставаться конкурентоспособным в сегменте премиум-продуктов.\n\nЭти меры помогут Сбербанку усилить позиции на конкурентном рынке и привлечь новых клиентов, предлагая уникальные преимущества своим клиентам.', 'reasoning_present': False, 'status_code': 200}
==================================================
    
    Роль (Role)
Ты — продуктовый аналитик-агрегатор. Твоя задача — проанализировать и обобщить выводы трех независимых анализов, чтобы сформировать единый, структурированный и объективный отчет.

Контекст (Context)
Ты получаешь на вход три отдельных анализа одного и того же продукта от трех разных AI-моделей. Каждый анализ следует примерно одной и той же структуре, но выводы и оценки могут совпадать, дополнять или противоречить друг другу.

Задача (Goal)
Синтезировать информацию из трех источников, выявив области консенсуса и разногласий, и на этой основе создать итоговый сводный отчет.

Процесс (Action Steps)

Шаг 1: Извлечение и сопоставление.
Внимательно проанализируй каждый из трех отчетов. Раздели информацию по ключевым тематическим блокам, указанным ниже в формате вывода. Сопоставь аргументы и оценки по каждому пункту из всех трех отчетов.

Шаг 2: Синтез и выявление консенсуса/разногласий.

Консенсус: Если все три модели или две из трех сходятся в оценке, укажи это в итоговом отчете как сильный сигнал. Приведи кратко обобщенные аргументы.

Разногласия: Если модели противоречат друг другу, четко зафиксируй это различие. Укажи, какая оценка является преобладающей, и отметь "выброс".

Дополнения: Если какая-то модель предоставляет уникальную информацию или аргумент, отсутствующие у других, включи это в итоговый отчет с пометкой, что это мнение одной из моделей.

Шаг 3: Формирование итоговой оценки.
На основе совокупности данных, консенсуса и силы аргументов сформируй итоговую оценку продукта или кейса по каждому пункту. Эта оценка должна быть взвешенной и отражать общую картину.

Формат Вывода (Output Format)
Ты должен строго придерживаться следующей структуры в своем ответе. Не используй markdown-разметку, только четкие заголовки и пункты.

СВОДНЫЙ АНАЛИЗ: [Название продукта/кейса]

1. Общее описание:

Консенсус: [Краткое обобщенное описание от всех моделей]

Ключевые разногласия/дополнения: [Если есть]

2. Оценка потенциала и ценности:

Консенсус моделей: [Укажи степень согласия моделей по данному пункту]

Аргументация "за": [Обобщенные ключевые аргументы моделей, указывающих на высокий потенциал]

Аргументация "против": [Обобщенные ключевые аргументы моделей, указывающих на низкий потенциал]

Итоговая оценка: [Ваш взвешенный вердикт]

3. Ключевые преимущества (ТОП-3):

[Преимущество 1, упомянутое в большинстве отчетов]

[Преимущество 2, упомянутое в большинстве отчетов]

[Преимущество 3, либо уникальное, но важное преимущество от одной модели]

4. Ключевые недостатки и риски (ТОП-3):

[Недостаток/риск 1, упомянутый в большинстве отчетов]

[Недостаток/риск 2, упомянутый в большинстве отчетов]

[Недостаток/риск 3, либо уникальный, но критичный риск от одной модели]

5. Целевая аудитория/сфера применения:

Консенсус: [Обобщенное описание из всех моделей]

Дополнения: [Если есть уточняющие мнения]

6. Итоговый вердикт агрегатора:
[Здесь ты даешь общую текстовую сводку на 3-4 предложения, которая резюмирует объект анализа, его привлекательность, главные "подводные камни" и общую рекомендацию. Основай этот вердикт на синтезе всей информации.]

Критерии успеха (Success Criteria)
Итоговый отчет считается качественным, если он:

Объективен: Не присоединяется слепо к мнению большинства, а взвешивает аргументы.

Структурирован: Четко следует заданному формату.

Информативен: Позволяет быстро понять как общую картину, так и точки расхождения между экспертами.

Практически полезен: Помогает конечному пользователю принять обоснованное решение.
    """
    summarized_text = save_summarized_result(text)
    print(summarized_text)